# LVS (Linux Virtual Server) è² è¼‰å‡è¡¡ PoC â€” å®Œæ•´æ•™å­¸

> æœ¬æ•™å­¸å¸¶ä½ å¾é›¶æ­å»ºä¸€å¥— **Layer-4 è² è¼‰å‡è¡¡å¢é›†**ï¼Œæ¡ç”¨ LVS / IPVS çš„ **DSR (Direct Server Return)** æ¨¡å¼ï¼Œä¸¦ä»¥ **Keepalived + VRRP** å¯¦ç¾ Director é«˜å¯ç”¨ã€‚é©åˆåˆå­¸è€…ç†è§£ã€ŒçœŸæ­£çš„ç”Ÿç”¢ç´šè² è¼‰å‡è¡¡ã€å¦‚ä½•é‹ä½œã€‚

---

## ç›®éŒ„

1. [ç‚ºä»€éº¼éœ€è¦ Load Balancerï¼Ÿ](#1-ç‚ºä»€éº¼éœ€è¦-load-balancer)
2. [æ ¸å¿ƒæ¦‚å¿µé€Ÿè¦½](#2-æ ¸å¿ƒæ¦‚å¿µé€Ÿè¦½)
3. [æ•´é«”æ¶æ§‹](#3-æ•´é«”æ¶æ§‹)
4. [ä¸‰ç¨® LVS è½‰ç™¼æ¨¡å¼æ¯”è¼ƒ](#4-ä¸‰ç¨®-lvs-è½‰ç™¼æ¨¡å¼æ¯”è¼ƒ)
5. [DSR æ¨¡å¼æ·±åº¦è§£æ](#5-dsr-æ¨¡å¼æ·±åº¦è§£æ)
6. [VRRP èˆ‡ Keepalived é«˜å¯ç”¨](#6-vrrp-èˆ‡-keepalived-é«˜å¯ç”¨)
7. [WRR æ’ç¨‹æ¼”ç®—æ³•](#7-wrr-æ’ç¨‹æ¼”ç®—æ³•)
8. [ç’°å¢ƒéœ€æ±‚èˆ‡å®‰è£](#8-ç’°å¢ƒéœ€æ±‚èˆ‡å®‰è£)
9. [å¢é›†æ¶æ§‹åœ–èˆ‡ç¶²è·¯è¦åŠƒ](#9-å¢é›†æ¶æ§‹åœ–èˆ‡ç¶²è·¯è¦åŠƒ)
10. [å¿«é€Ÿå•Ÿå‹•](#10-å¿«é€Ÿå•Ÿå‹•)
11. [å¢é›†ç®¡ç†æŒ‡ä»¤](#11-å¢é›†ç®¡ç†æŒ‡ä»¤)
12. [æ¸¬è©¦è…³æœ¬èªªæ˜](#12-æ¸¬è©¦è…³æœ¬èªªæ˜)
13. [å®¹å™¨è¨­è¨ˆè©³è§£](#13-å®¹å™¨è¨­è¨ˆè©³è§£)
14. [ç–‘é›£æ’è§£](#14-ç–‘é›£æ’è§£)
15. [æ“´å……æ–¹å‘](#15-æ“´å……æ–¹å‘)
16. [PoC å¯¦æ¸¬çµæœ](#16-poc-å¯¦æ¸¬çµæœ)
17. [è™›æ“¬åŒ–å¹³å°è©•æ¯”ï¼šVMware vs KVM vs VirtualBox vs Docker](#17-è™›æ“¬åŒ–å¹³å°è©•æ¯”vmware-vs-kvm-vs-virtualbox-vs-docker)
18. [Docker Compose åš LVSï¼šèƒ½åŠ›é‚Šç•Œèˆ‡ç”Ÿç”¢å·®ç•°åˆ†æ](#18-docker-compose-åš-lvsèƒ½åŠ›é‚Šç•Œèˆ‡ç”Ÿç”¢å·®ç•°åˆ†æ)
19. [åˆå­¸è€…å®Œæ•´æ“ä½œæ•™å­¸ (Step-by-Step)](#19-åˆå­¸è€…å®Œæ•´æ“ä½œæ•™å­¸-step-by-step)

---

## 1. ç‚ºä»€éº¼éœ€è¦ Load Balancerï¼Ÿ

ç•¶å–®ä¸€ä¼ºæœå™¨ç„¡æ³•æ‰¿å—æ‰€æœ‰æµé‡æ™‚ï¼Œæˆ‘å€‘éœ€è¦**å¤šå°ä¼ºæœå™¨**åˆ†æ“”å·¥ä½œã€‚Load Balancerï¼ˆè² è¼‰å‡è¡¡å™¨ï¼‰å°±æ˜¯ç«™åœ¨ã€Œå‰é¢ã€çš„äº¤é€šè­¦å¯Ÿï¼š

```
                    æ²’æœ‰ LB                          æœ‰ LB
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  å…¨éƒ¨æµé‡ â”€â”€â”€â”€â”€â”€â–ºâ”‚ å–®ä¸€ä¼ºæœå™¨â”‚    æµé‡ â”€â”€â”€â”€â–ºâ”‚  Load Balancer   â”‚
                  â”‚ (å®¹æ˜“æ›) â”‚              â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚      â”‚      â”‚
                                           Server1 Server2 Server3
                                           (åˆ†æ•£å£“åŠ›ï¼Œä»»ä¸€å°æ›äº†ä¸å½±éŸ¿æœå‹™)
```

**Load Balancer çš„ä¸‰å¤§å¥½è™•ï¼š**

| å¥½è™• | èªªæ˜ |
|------|------|
| **å¯æ“´å±•æ€§ (Scalability)** | æµé‡è®Šå¤§ï¼ŸåŠ æ©Ÿå™¨å°±å¥½ |
| **é«˜å¯ç”¨ (High Availability)** | ä¸€å°æ›äº†è‡ªå‹•åˆ‡æ›åˆ°å…¶ä»–å° |
| **éˆæ´»éƒ¨ç½²** | å¯ä»¥åšæ»¾å‹•å‡ç´šã€A/B æ¸¬è©¦ |

---

## 2. æ ¸å¿ƒæ¦‚å¿µé€Ÿè¦½

åœ¨é–‹å§‹ä¹‹å‰ï¼Œå…ˆèªè­˜é€™äº›é—œéµè¡“èªï¼š

| è¡“èª | å…¨å | ç™½è©±è§£é‡‹ |
|------|------|---------|
| **LVS** | Linux Virtual Server | Linux å…§å»ºçš„ Layer-4 è² è¼‰å‡è¡¡æ¡†æ¶ |
| **IPVS** | IP Virtual Server | LVS åœ¨ kernel è£¡çš„å¯¦ä½œæ¨¡çµ„ |
| **VIP** | Virtual IP | å°å¤–å…¬é–‹çš„ IPï¼ŒClient åªèªé€™å€‹ |
| **Director** | â€” | è² è²¬åˆ†é…æµé‡çš„ç¯€é»ï¼ˆé‹è¡Œ IPVSï¼‰ |
| **Real Server (RS)** | â€” | å¯¦éš›è™•ç†è«‹æ±‚çš„å¾Œç«¯ä¼ºæœå™¨ |
| **DSR / DR** | Direct Server Return / Direct Routing | å›æ‡‰ä¸ç¶“é Directorï¼Œç›´æ¥å› Client |
| **VRRP** | Virtual Router Redundancy Protocol | è®“å¤šå€‹ Director å…±äº« VIP çš„å”å®š |
| **Keepalived** | â€” | å¯¦ä½œ VRRP + å¥åº·æª¢æŸ¥çš„ daemon |
| **WRR** | Weighted Round Robin | æŒ‰æ¬Šé‡è¼ªæµåˆ†é…è«‹æ±‚ |

---

## 3. æ•´é«”æ¶æ§‹

```
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚      Client VM       â”‚
                            â”‚   192.168.100.50     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                            â‘  Client é€ Request åˆ° VIP
                                 192.168.100.100
                                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚          VRRP (Keepalived)           â”‚
                    â”‚    â‘¡ VIP æµ®å‹•åœ¨ MASTER Director ä¸Š   â”‚
                    â”‚                                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
              â”‚ Director-1 â”‚    VIP Failover (HA)   â”‚ Director-2 â”‚
              â”‚  MASTER    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  BACKUP    â”‚
              â”‚ .100.10    â”‚                         â”‚ .100.11    â”‚
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
           â‘¢ IPVS ç”¨ DR æ¨¡å¼è½‰ç™¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                 â”‚
     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”        â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”
     â”‚  RS-1  â”‚        â”‚  RS-2  â”‚
     â”‚  w=3   â”‚        â”‚  w=2   â”‚
     â”‚ .100.21â”‚        â”‚ .100.22â”‚
     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
     â‘£ Response DIRECTLY to Client
        (bypasses Director = DSR)
```

**è³‡æ–™æµå››æ­¥é©Ÿï¼š**

1. **Client â†’ VIP**ï¼šClient é€ HTTP request åˆ° VIP `192.168.100.100`
2. **VIP â†’ Director**ï¼šå› ç‚º VIP ç¶åœ¨ MASTER Director ä¸Šï¼ŒDirector æ”¶åˆ°å°åŒ…
3. **Director â†’ Real Server**ï¼šIPVS é€é DR æ¨¡å¼è½‰ç™¼ï¼ˆåªæ”¹ MACï¼Œä¸æ”¹ IPï¼‰
4. **Real Server â†’ Client**ï¼šRS ç›´æ¥å›æ‡‰ Clientï¼ˆ**ä¸ç¶“é Director**ï¼‰

---

## 4. ä¸‰ç¨® LVS è½‰ç™¼æ¨¡å¼æ¯”è¼ƒ

LVS æ”¯æ´ä¸‰ç¨®è½‰ç™¼æ¨¡å¼ï¼Œå„æœ‰å„ªç¼ºé»ï¼š

```
 â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
 â•‘               â•‘   NAT æ¨¡å¼       â•‘   DR æ¨¡å¼ (DSR)  â•‘   TUN æ¨¡å¼       â•‘
 â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
 â•‘ Request è·¯å¾‘   â•‘ Clientâ†’Dirâ†’RS   â•‘ Clientâ†’Dirâ†’RS   â•‘ Clientâ†’Dirâ†’RS   â•‘
 â•‘ Response è·¯å¾‘  â•‘ RSâ†’Dirâ†’Client   â•‘ RSâ†’Client â­    â•‘ RSâ†’Client â­    â•‘
 â•‘ Director è² æ“”  â•‘ é«˜ (é›™å‘æµé‡)    â•‘ ä½ (åªçœ‹ Request) â•‘ ä½ (åªçœ‹ Request) â•‘
 â•‘ RS éœ€è¦æ”¹è¨­å®š  â•‘ åªæ”¹ Gateway     â•‘ ARP + lo VIP     â•‘ IP Tunnel        â•‘
 â•‘ è·¨å­ç¶²         â•‘ âœ…              â•‘ âŒ åŒä¸€å­ç¶²       â•‘ âœ…               â•‘
 â•‘ é©åˆå ´æ™¯       â•‘ å°è¦æ¨¡          â•‘ å¤§è¦æ¨¡ Web â­    â•‘ è·¨æ©Ÿæˆ¿           â•‘
 â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**æœ¬ PoC é¸æ“‡ DR (DSR) æ¨¡å¼**ï¼Œå› ç‚ºï¼š
- Response é€šå¸¸æ¯” Request å¤§å¾ˆå¤šï¼ˆæƒ³æƒ³ä¸‹è¼‰ä¸€å¼µåœ–ç‰‡ï¼šRequest 100 bytesï¼ŒResponse 5MBï¼‰
- Director åªè™•ç†å°å°çš„ Requestï¼Œthroughput å¯ä»¥éå¸¸é«˜
- é©åˆå¤§éƒ¨åˆ†åœ¨åŒä¸€æ©Ÿæˆ¿çš„ Web æ‡‰ç”¨

---

## 5. DSR æ¨¡å¼æ·±åº¦è§£æ

DSR æ˜¯æœ¬ PoC çš„æ ¸å¿ƒï¼Œè®“æˆ‘å€‘ç”¨å°åŒ…å±¤ç´šä¾†ç†è§£ï¼š

### 5.1 å°åŒ…åœ¨æ¯ä¸€ç«™çš„è®ŠåŒ–

```
Step 1: Client â†’ Director
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Src MAC:     â”‚ Src IP:      â”‚                â”‚
â”‚  Client MAC  â”‚  Client IP   â”‚  HTTP Request  â”‚
â”‚ Dst MAC:     â”‚ Dst IP:      â”‚                â”‚
â”‚  Dir MAC     â”‚  VIP â­      â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: Director â†’ Real Server (DR è½‰ç™¼)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Src MAC:     â”‚ Src IP:      â”‚                â”‚
â”‚  Dir MAC     â”‚  Client IP   â”‚  HTTP Request  â”‚
â”‚ Dst MAC:     â”‚ Dst IP:      â”‚  (ä¸è®Š)        â”‚
â”‚  RS MAC â­   â”‚  VIP â­      â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â–²                â–²
   åªæ”¹ MACï¼        IP å®Œå…¨ä¸å‹•ï¼

Step 3: Real Server â†’ Client (ç›´æ¥å›æ‡‰)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Src MAC:     â”‚ Src IP:      â”‚                â”‚
â”‚  RS MAC      â”‚  VIP â­      â”‚  HTTP Response â”‚
â”‚ Dst MAC:     â”‚ Dst IP:      â”‚  (5MB åœ–ç‰‡)   â”‚
â”‚  GW MAC      â”‚  Client IP   â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â–²
   RS ç”¨ VIP ç•¶ Src IP â†’ Client è¦ºå¾—æ˜¯ VIP å›çš„
   å®Œå…¨ä¸ç¶“é Directorï¼
```

### 5.2 ç‚ºä»€éº¼ RS éœ€è¦ç‰¹æ®Šè¨­å®šï¼Ÿ

DSR æ¨¡å¼ä¸‹ï¼ŒRS å¿…é ˆåšå…©ä»¶äº‹ï¼š

**a) VIP ç¶åœ¨ loopback ä¸Š**
```bash
# RS éœ€è¦ã€Œèªè­˜ã€VIPï¼Œå¦å‰‡æ”¶åˆ°ç›®çš„åœ°æ˜¯ VIP çš„å°åŒ…æœƒä¸Ÿæ£„
ip addr add 192.168.100.100/32 dev lo label lo:0
```

**b) ARP æŠ‘åˆ¶**
```bash
# RS ä¸èƒ½å›æ‡‰ã€Œèª°æ˜¯ VIPï¼Ÿã€çš„ ARP æŸ¥è©¢ï¼Œå¦å‰‡æœƒæ¶èµ° Director çš„æµé‡
net.ipv4.conf.all.arp_ignore = 1    # åªå›æ‡‰è‡ªå·±ç¶²å¡ä¸Šçš„ IP
net.ipv4.conf.all.arp_announce = 2  # ARP å…¬å‘Šæ™‚ç”¨æœ€é©åˆçš„ IP
```

---

## 6. VRRP èˆ‡ Keepalived é«˜å¯ç”¨

### 6.1 å•é¡Œï¼šDirector æ˜¯å–®é»æ•…éšœ

å¦‚æœåªæœ‰ä¸€å€‹ Directorï¼Œå®ƒæ›äº†æ•´å€‹æœå‹™å°±æ–·äº†ã€‚è§£æ³•æ˜¯ç”¨ **VRRP å”å®š** è®“å…©å€‹ Director å…±äº« VIPã€‚

### 6.2 VRRP å·¥ä½œåŸç†

```
æ­£å¸¸ç‹€æ…‹ï¼š                         æ•…éšœå¾Œï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Director-1   â”‚                  â”‚ Director-1   â”‚
â”‚ MASTER â­    â”‚  â”€â”€(æ›äº†)â”€â”€â–º    â”‚ âŒ DOWN      â”‚
â”‚ VIP: .100    â”‚                  â”‚              â”‚
â”‚ Priority:100 â”‚                  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Director-2   â”‚                  â”‚ Director-2   â”‚
â”‚ BACKUP       â”‚  â”€â”€(æ¥æ‰‹)â”€â”€â–º    â”‚ MASTER â­    â”‚
â”‚ (å¾…å‘½)       â”‚                  â”‚ VIP: .100    â”‚
â”‚ Priority: 90 â”‚                  â”‚ Priority: 90 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     VIP åœ¨ Director-1              VIP è‡ªå‹•è½‰ç§»åˆ° Director-2
     Director-2 å¾…å‘½                 äºç§’ç´š Failoverï¼
```

### 6.3 Keepalived åšçš„ä¸‰ä»¶äº‹

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| **VRRP** | ç®¡ç† VIP åœ¨ MASTER/BACKUP é–“çš„æ¼‚ç§» |
| **Health Check** | å®šæœŸ HTTP GET `/health` æª¢æŸ¥ RS å¥åº· |
| **IPVS ç®¡ç†** | è‡ªå‹•æ–°å¢/ç§»é™¤ Real Server åˆ° IPVS è¡¨ |

---

## 7. WRR æ’ç¨‹æ¼”ç®—æ³•

WRR (Weighted Round Robin) æŒ‰æ¬Šé‡åˆ†é…è«‹æ±‚ï¼š

```
Real Server    Weight    é æœŸæµé‡ä½”æ¯”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RS-1           3         60%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
RS-2           2         40%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
```

å¦‚æœæœ‰ 100 å€‹è«‹æ±‚ï¼Œå¤§ç´„ 60 å€‹çµ¦ RS-1ï¼Œ40 å€‹çµ¦ RS-2ã€‚

**å…¶ä»–å¸¸è¦‹æ’ç¨‹ç®—æ³•ï¼š**

| ç®—æ³• | èªªæ˜ | é©åˆå ´æ™¯ |
|------|------|---------|
| `rr` | Round Robin | æ‰€æœ‰ RS æ€§èƒ½ç›¸åŒ |
| `wrr` | Weighted RR â­ | RS æ€§èƒ½ä¸åŒ |
| `lc` | Least Connection | é•·é€£æ¥ |
| `wlc` | Weighted LC | é•·é€£æ¥ + ä¸åŒæ€§èƒ½ |
| `sh` | Source Hash | éœ€è¦ Session è¦ªå’Œ |

---

## 8. ç’°å¢ƒéœ€æ±‚èˆ‡å®‰è£

### ç¡¬é«”éœ€æ±‚

æœ¬ PoC ä½¿ç”¨ Docker å®¹å™¨ï¼Œè³‡æºéœ€æ±‚æ¥µä½ï¼š

| å®¹å™¨ | è§’è‰² | æ•¸é‡ |
|------|------|------|
| Director | IPVS + Keepalived | 2 |
| Real Server | Nginx | 2 |
| Client | æ¸¬è©¦å·¥å…· | 1 |
| **Total** | | **5 containers** |

### è»Ÿé«”éœ€æ±‚

- **Docker** 20.10+ åŠ **Docker Compose** V2
- **Linux æ ¸å¿ƒ**éœ€æ”¯æ´ IPVS æ¨¡çµ„ (`ip_vs`, `ip_vs_wrr`, `ip_vs_rr`)

```bash
# æª¢æŸ¥ Docker
docker --version
docker compose version

# è¼‰å…¥ IPVS æ ¸å¿ƒæ¨¡çµ„ (å¦‚å°šæœªè¼‰å…¥)
sudo modprobe ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh
```

> **ç‚ºä»€éº¼ç”¨ Dockerï¼Ÿ**
> - ç§’ç´šå•Ÿå‹•ï¼ˆå°æ¯” VM çš„åˆ†é˜ç´šï¼‰
> - ä¸éœ€è¦ VMware/VirtualBox/KVM
> - IPVS åœ¨ Linux æ ¸å¿ƒå±¤é‹ä½œï¼Œprivileged container å¯å®Œç¾æ”¯æ´ DSR æ¨¡å¼
> - ç¶²è·¯éš”é›¢é€é Docker bridge network å¯¦ç¾

---

## 9. å¢é›†æ¶æ§‹åœ–èˆ‡ç¶²è·¯è¦åŠƒ

```
Network: 192.168.100.0/24

 .10  â”€â”€â”€â”€ lvs-director-1 (MASTER, VIP .100)
 .11  â”€â”€â”€â”€ lvs-director-2 (BACKUP)
 .21  â”€â”€â”€â”€ real-server-1   (Nginx, weight=3)
 .22  â”€â”€â”€â”€ real-server-2   (Nginx, weight=2)
 .50  â”€â”€â”€â”€ client           (Test tools)
 .100 â”€â”€â”€â”€ VIP (floating, managed by Keepalived)
```

### è¨­è¨ˆæ±ºç­–

| é¢å‘ | é¸æ“‡ | ç†ç”± |
|------|------|------|
| **LB æ¨¡å¼** | DR (DSR) | Response ç¹é Director â†’ é«˜ throughput |
| **æ’ç¨‹ç®—æ³•** | WRR | æ”¯æ´ç•°è³ªå¾Œç«¯ (ä¸åŒæ€§èƒ½) |
| **é«˜å¯ç”¨** | Keepalived + VRRP | æ¥­ç•Œæ¨™æº–ï¼Œäºç§’ç´š failover |
| **å¥åº·æª¢æŸ¥** | HTTP GET /health | æ‡‰ç”¨å±¤æª¢æŸ¥ï¼Œè€Œéåªæ˜¯ TCP |
| **Session è¦ªå’Œ** | 60s source-hash | æœ‰ç‹€æ…‹æ‡‰ç”¨çš„ session affinity |
| **ARP è™•ç†** | arp_ignore=1, arp_announce=2 | é˜²æ­¢ RS æ¶ VIP çš„ ARP |

---

## 10. å¿«é€Ÿå•Ÿå‹•

```bash
# 1. Clone å°ˆæ¡ˆ
cd service-load-balancer

# 2. è®“è…³æœ¬å¯åŸ·è¡Œ
chmod +x manage.sh

# 3. å•Ÿå‹•å¢é›† (é¦–æ¬¡éœ€å»ºç½® imageï¼Œç´„ 1-2 åˆ†é˜)
./manage.sh up

# 4. åŸ·è¡Œæ¸¬è©¦
./manage.sh test

# 5. æ¸¬è©¦ Failover
./manage.sh failover
./manage.sh recover

# 6. åœæ­¢å¢é›†
./manage.sh down
```

---

## 11. å¢é›†ç®¡ç†æŒ‡ä»¤

```bash
./manage.sh up              # å•Ÿå‹•æ‰€æœ‰å®¹å™¨ (docker compose up)
./manage.sh down            # åœæ­¢æ‰€æœ‰å®¹å™¨
./manage.sh destroy         # éŠ·æ¯€æ‰€æœ‰å®¹å™¨å’Œæ˜ åƒæª” (âš ï¸ ä¸å¯é€†)
./manage.sh status          # é¡¯ç¤ºå¢é›†ç‹€æ…‹
./manage.sh test            # å¾ Client åŸ·è¡Œå®Œæ•´æ¸¬è©¦
./manage.sh exec <container># é€²å…¥æŒ‡å®šå®¹å™¨çš„ shell
./manage.sh failover        # æ¨¡æ“¬ Director æ•…éšœ
./manage.sh recover         # æ¢å¾© Director
./manage.sh ipvs            # é¡¯ç¤º IPVS è·¯ç”±è¡¨
./manage.sh logs            # é¡¯ç¤º Keepalived æ—¥èªŒ
```

---

## 12. æ¸¬è©¦è…³æœ¬èªªæ˜

å¾ Client å®¹å™¨å…§åŸ·è¡Œï¼š

```bash
# é€²å…¥ Client å®¹å™¨
docker exec -it lvs-client bash

# å®Œæ•´æ¸¬è©¦å¥—ä»¶
test-all.sh

# å€‹åˆ¥æ¸¬è©¦
test-basic.sh              # åŸºæœ¬é€£ç·šæ¸¬è©¦
test-distribution.sh 100   # è² è¼‰åˆ†é… (100 æ¬¡è«‹æ±‚)
test-performance.sh 10 500 # æ•ˆèƒ½æ¸¬è©¦ (10 ä¸¦ç™¼ï¼Œ500 è«‹æ±‚)
test-failover.sh 60        # Failover ç›£æ§ (60 ç§’)
test-dsr-verify.sh         # DSR å°åŒ…é©—è­‰
```

### DSR é©—è­‰

ç¢ºèª DSR é‹ä½œæ­£å¸¸ï¼š

```bash
# æ–¹æ³• 1ï¼šå¾ Client å®¹å™¨åŸ·è¡Œ DSR é©—è­‰è…³æœ¬
docker exec lvs-client test-dsr-verify.sh

# æ–¹æ³• 2ï¼šæª¢æŸ¥ Director çš„ IPVS çµ±è¨ˆ
docker exec lvs-director-1 ipvsadm -Ln --stats
# è§€å¯Ÿ OutPkts=0 å’Œ OutBytes=0 â†’ è­‰æ˜ Director ä¸è½‰ç™¼å›æ‡‰å°åŒ…
```

é æœŸè¡Œç‚ºï¼š
- **Request è·¯å¾‘**ï¼šClient (`.50`) â†’ VIP (`.100`) on Director
- **Response è·¯å¾‘**ï¼šReal Server (`.21/.22`) â†’ Client (`.50`) **ç›´æ¥å›**
- Director **åªçœ‹åˆ° Requestï¼Œçœ‹ä¸åˆ° Response**ï¼ˆ`OutPkts=0`ï¼‰

---

## 13. å®¹å™¨è¨­è¨ˆè©³è§£

### 13.1 Director å®¹å™¨ (`docker/director/`)

```
Dockerfile: Ubuntu 22.04 + ipvsadm + keepalived
                    â”‚
entrypoint.sh:      â–¼
åµæ¸¬ Service Network ä»‹é¢ (eth0)
         â”‚
         â–¼
ä¾æ“šç’°å¢ƒè®Šæ•¸å‹•æ…‹ç”Ÿæˆ keepalived.confï¼š
  â”œâ”€â”€ VRRP Instance (VIP æ¼‚ç§»)
  â”œâ”€â”€ Virtual Server (IPVS DR æ¨¡å¼)
  â”œâ”€â”€ Real Server å®šç¾© (å« weight)
  â””â”€â”€ HTTP Health Check (/health)
         â”‚
         â–¼
å»ºç«‹ Sorry Server (æ‰€æœ‰ RS æ›äº†æ™‚çš„å‚™æ´é é¢)
         â”‚
         â–¼
å•Ÿå‹• Keepalived (foreground, ä½œç‚ºå®¹å™¨ä¸»ç¨‹åº)
```

ç’°å¢ƒè®Šæ•¸ï¼š
| è®Šæ•¸ | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|
| `KEEPALIVED_ROLE` | MASTER æˆ– BACKUP | `MASTER` |
| `KEEPALIVED_PRIORITY` | VRRP å„ªå…ˆæ¬Š | `100` |
| `VIP` | è™›æ“¬ IP | `192.168.100.100` |
| `REAL_SERVERS_CSV` | RS æ¸…å–® (IP:weight) | `192.168.100.21:3,192.168.100.22:2` |

### 13.2 Real Server å®¹å™¨ (`docker/realserver/`)

```
Dockerfile: Nginx 1.24 + iproute2
                    â”‚
entrypoint.sh:      â–¼
ARP æŠ‘åˆ¶è¨­å®šï¼š
  â”œâ”€â”€ arp_ignore = 1
  â””â”€â”€ arp_announce = 2
    â”‚
    â–¼
VIP ç¶åœ¨ loopback (lo:0)ï¼š
  â””â”€â”€ ip addr add VIP/32 dev lo
    â”‚
    â–¼
Nginx è¨­å®šï¼š
  â”œâ”€â”€ /health â†’ 200 OK
  â”œâ”€â”€ /api/info.json â†’ ä¼ºæœå™¨è³‡è¨Š (JSON)
  â””â”€â”€ / â†’ é¦–é  (é¡¯ç¤ºä¼ºæœå™¨èº«ä»½)
    â”‚
    â–¼
å•Ÿå‹• Nginx (foreground)
```

### 13.3 Client å®¹å™¨ (`docker/client/`)

å®‰è£ `curl`, `ab` (Apache Bench), `tcpdump`, `jq`ï¼Œä¸¦éƒ¨ç½² 5 å€‹æ¸¬è©¦è…³æœ¬åˆ° `/usr/local/bin/`ã€‚

---

## 14. ç–‘é›£æ’è§£

### VIP æœªåˆ†é…

```bash
docker logs lvs-director-1       # æª¢æŸ¥ Keepalived æ—¥èªŒ
docker exec lvs-director-1 ip addr show  # ç¢ºèª VIP æ˜¯å¦å‡ºç¾
```

### Real Server æ²’æ”¶åˆ°æµé‡

```bash
docker exec real-server-1 rs-status.sh   # æª¢æŸ¥ VIP on loã€ARP è¨­å®š
docker exec real-server-1 curl -s http://localhost/health  # ç¢ºèª Nginx æ­£å¸¸
docker exec real-server-1 cat /proc/sys/net/ipv4/conf/all/arp_ignore   # å¿…é ˆæ˜¯ 1
docker exec real-server-1 cat /proc/sys/net/ipv4/conf/all/arp_announce # å¿…é ˆæ˜¯ 2
```

### IPVS é¡¯ç¤º 0 é€£ç·š

```bash
docker exec lvs-director-1 ipvsadm -Ln           # ç¢ºèª Real Server å·²åˆ—å‡º
docker exec lvs-director-1 ipvsadm -Ln --stats   # ç¢ºèªå°åŒ…è¨ˆæ•¸
```

### IPVS æ ¸å¿ƒæ¨¡çµ„æœªè¼‰å…¥

å¦‚æœ Director å•Ÿå‹•å¾Œ ipvsadm å ±éŒ¯ï¼š
```bash
sudo modprobe ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh
# æ°¸ä¹…è¼‰å…¥ï¼š
echo -e "ip_vs\nip_vs_rr\nip_vs_wrr\nip_vs_sh" | sudo tee /etc/modules-load.d/ipvs.conf
```

---

## 15. æ“´å……æ–¹å‘

### æ–°å¢ HTTPS (TLS Termination at RS)

```bash
# åœ¨æ¯å° RS ä¸Šè¨­å®š Nginx SSL
# æ›´æ–° keepalived: virtual_server VIP 443 + lb_kind DR
```

### åˆ‡æ›åˆ° IPVS Tunnel æ¨¡å¼ (è·¨å­ç¶² DSR)

```
# åœ¨ keepalived.conf ä¸­æ”¹:
lb_kind DR  â†’  lb_kind TUN
# RS éœ€è¦è¨­å®š ipip tunnel å–ä»£ lo VIP
```

### åŠ å…¥ Prometheus ç›£æ§

```bash
# åœ¨ Director å®‰è£ ipvs_exporter
# åœ¨æ‰€æœ‰ç¯€é»å®‰è£ node_exporter
# å¦èµ·ä¸€å° VM éƒ¨ç½² Prometheus + Grafana
```

### å¢åŠ  Real Server

åœ¨ `docker-compose.yml` ä¸­æ–°å¢ä¸€å€‹ Real Server å®šç¾©ï¼Œä¸¦æ›´æ–° Directors çš„ `REAL_SERVERS_CSV`ï¼š

```yaml
# æ–°å¢ real-server-3
real-server-3:
  build:
    context: ./docker/realserver
  container_name: real-server-3
  hostname: real-server-3
  privileged: true
  cap_add:
    - NET_ADMIN
  networks:
    lvs-net:
      ipv4_address: 192.168.100.23
  environment:
    - RS_IP=192.168.100.23
    - RS_NAME=real-server-3
    - VIP=192.168.100.100

# æ›´æ–° Directors çš„ REAL_SERVERS_CSV:
# REAL_SERVERS_CSV=192.168.100.21:3,192.168.100.22:2,192.168.100.23:1
```

ç„¶å¾Œé‡æ–°å•Ÿå‹•å¢é›†ï¼š`./manage.sh down && ./manage.sh up`

---

## 16. PoC å¯¦æ¸¬çµæœ

ä»¥ä¸‹æ˜¯å¯¦éš›åŸ·è¡Œçš„æ¸¬è©¦çµæœï¼š

### åŸºæœ¬é€£ç·šæ¸¬è©¦

```
âœ… VIP 192.168.100.100 å¯é” (0% packet loss)
âœ… HTTP 200 OK
âœ… 10 æ¬¡è«‹æ±‚äº¤æ›¿åˆ†é…åˆ° real-server-1 å’Œ real-server-2
```

### è² è¼‰åˆ†é… (WRR 3:2)

```
real-server-1 : 30 requests (60.0%) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
real-server-2 : 20 requests (40.0%) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
Total: 50/50 æˆåŠŸ
```

ç²¾ç¢ºç¬¦åˆ WRR æ¬Šé‡ 3:2 = 60%:40% çš„é æœŸï¼

### æ•ˆèƒ½æ¸¬è©¦ (Apache Bench)

```
Requests per second: 18,538 req/sec
Failed requests:     0
Time per request:    0.054 ms (across all concurrent)
```

### Failover æ¸¬è©¦

```
Before: VIP on lvs-director-1
Action: docker stop lvs-director-1
After:  âœ… VIP moved to lvs-director-2
        Client ä»å¯é€é VIP å­˜å–å¾Œç«¯
Recovery: âœ… VIP preempted back to lvs-director-1
```

### DSR é©—è­‰ (IPVS Statistics)

```
                    InPkts  OutPkts  InBytes  OutBytes
VIP:80               105      0       6765       0     â† OutPkts=0 è­‰æ˜ DSR
â†’ RS-1:80             63      0       4059       0
â†’ RS-2:80             42      0       2706       0
```

`OutPkts=0` å’Œ `OutBytes=0` ç¢ºèª **Director ä¸è½‰ç™¼å›æ‡‰å°åŒ…**ï¼Œå›æ‡‰ç›´æ¥å¾ Real Server è¿”å› Client â€” é€™å°±æ˜¯ DSR çš„æ ¸å¿ƒç‰¹å¾µï¼

---

## 17. è™›æ“¬åŒ–å¹³å°è©•æ¯”ï¼šVMware vs KVM vs VirtualBox vs Docker

æœ¬ PoC åœ¨æœ€çµ‚æ¡ç”¨ Docker ä¹‹å‰ï¼Œä¾åºæ¸¬è©¦äº†ä¸‰ç¨® Hypervisor æ–¹æ¡ˆï¼ˆVagrant + VMï¼‰ã€‚ä»¥ä¸‹è¨˜éŒ„æ¯å€‹æ–¹æ¡ˆçš„**å¯¦æ¸¬éç¨‹ã€é­é‡çš„å•é¡Œã€è§£æ³•èˆ‡æœ€çµ‚çµè«–**ï¼Œä¾›è®€è€…åœ¨é¸å‹æ™‚åƒè€ƒã€‚

### æ¸¬è©¦ç’°å¢ƒ

| é …ç›® | è¦æ ¼ |
|------|------|
| **OS** | Ubuntu 24.04 LTS (kernel 6.14.0-1020-oem) |
| **CPU** | Intel Core (16 cores), VT-x æ”¯æ´ |
| **RAM** | 24 GB |
| **Vagrant** | 2.4.9 |
| **Vagrant Box** | `generic/ubuntu2204`, `bento/ubuntu-22.04` |

---

### 17.1 VMware Workstation 25

**ç‰ˆæœ¬**ï¼šVMware Workstation 25 (free personal use license)
**Plugin**ï¼švagrant-vmware-desktop 3.0.5 + vagrant-vmware-utility

#### é­é‡å•é¡Œèˆ‡è§£æ³•

| # | å•é¡Œ | æ ¹å›  | è§£æ³• | çµæœ |
|---|------|------|------|------|
| 1 | Snapshot å¤±æ•—ï¼Œ`-T player` flag éŒ¯èª¤ | vagrant-vmware-utility åµæ¸¬åˆ° "standard license"ï¼Œä»¥ player æ¨¡å¼å•Ÿå‹• | å»ºç«‹ systemd override åŠ å…¥ `-license-override professional` | âœ… å·²è§£æ±º |
| 2 | vmnet è£ç½®å•Ÿå‹•å¤±æ•— | vmnet kernel module ä¸ç›¸å®¹ kernel 6.14.0 | `sudo vmware-modconfig --console --install-all` é‡æ–°ç·¨è­¯ | âœ… å·²è§£æ±º |
| 3 | VM å¡åœ¨ "Waiting for the VM to receive an address..." | Guest å…§ `open-vm-tools` ä¸ç›¸å®¹ VMware Workstation 25ï¼ŒVMware Tools state = `unknown` | ç„¡æ³•è§£æ±º â€” æ› `bento/ubuntu-22.04` box åŒæ¨£å¤±æ•— | âŒ **Blocker** |

#### è©³ç´°èªªæ˜

**å•é¡Œ 1ï¼šLicense åµæ¸¬éŒ¯èª¤**

VMware Workstation 25 æ”¹ç‚ºå…è²»å€‹äººä½¿ç”¨ï¼Œä½† vagrant-vmware-utility ä»å°‡å…¶è¾¨è­˜ç‚º "standard license" ä¸¦ä»¥ `-T player` æ¨¡å¼å•Ÿå‹• VMï¼Œå°è‡´ snapshot æ“ä½œå¤±æ•—ã€‚

```bash
# è§£æ³•ï¼šå»ºç«‹ systemd override
sudo mkdir -p /etc/systemd/system/vagrant-vmware-utility.service.d
sudo tee /etc/systemd/system/vagrant-vmware-utility.service.d/override.conf << 'EOF'
[Service]
ExecStart=
ExecStart=/opt/vagrant-vmware-desktop/bin/vagrant-vmware-utility api \
  -config-file=/opt/vagrant-vmware-desktop/config/service.hcl \
  -license-override professional
EOF
sudo systemctl daemon-reload && sudo systemctl restart vagrant-vmware-utility
```

**å•é¡Œ 2ï¼šKernel Module ä¸ç›¸å®¹**

OEM kernel (6.14.0-1020-oem) æœªé è£ VMware çš„ vmnet/vmmon æ¨¡çµ„ã€‚

```bash
# è§£æ³•ï¼šé‡æ–°ç·¨è­¯æ‰€æœ‰ VMware kernel modules
sudo vmware-modconfig --console --install-all
```

**å•é¡Œ 3ï¼šGuest Tools ä¸ç›¸å®¹ï¼ˆè‡´å‘½ï¼‰**

`generic/ubuntu2204` å’Œ `bento/ubuntu-22.04` å…©ç¨® box çš„ `open-vm-tools` éƒ½ç„¡æ³•èˆ‡ VMware Workstation 25 æ­£ç¢ºé€šè¨Šã€‚Guest VM å•Ÿå‹•å¾Œï¼ŒVMware Tools ç‹€æ…‹ç‚º `unknown`ï¼ŒVagrant æ°¸é æ”¶ä¸åˆ° Guest IPï¼Œtimeout å¾Œå¤±æ•—ã€‚

```
VMware Tools state: unknown   â† å•é¡Œæ ¸å¿ƒ
Vagrant ç­‰å¾… IP â†’ æ°¸ä¹… timeout
```

#### çµè«–

> âŒ **ä¸å¯ç”¨**ã€‚VMware Workstation 25 + Vagrant åœ¨æ–°ç‰ˆ kernel ä¸Šæœ‰æ ¹æœ¬æ€§çš„ Guest Tools ç›¸å®¹æ€§å•é¡Œï¼Œç›®å‰æ²’æœ‰å¯è¡Œçš„è§£æ³•ã€‚

---

### 17.2 KVM / libvirt

**ç‰ˆæœ¬**ï¼šlibvirt 10.0.0, QEMU 8.2.2
**Plugin**ï¼švagrant-libvirt (éœ€å®‰è£ `libvirt-dev` ç·¨è­¯)

#### é­é‡å•é¡Œèˆ‡è§£æ³•

| # | å•é¡Œ | æ ¹å›  | è§£æ³• | çµæœ |
|---|------|------|------|------|
| 1 | vagrant-libvirt plugin å®‰è£å¤±æ•— | ç¼ºå°‘ `libvirt-dev` å¥—ä»¶ | `sudo apt-get install -y libvirt-dev` | âœ… å·²è§£æ±º |
| 2 | VMware vmnet ç¶²è·¯è¡çª | vmnet ä½”ç”¨ 192.168.100.0/24 | `sudo vmware-networks --stop` | âœ… å·²è§£æ±º |
| 3 | libvirt default storage pool ä¸å­˜åœ¨ | ç³»çµ±æœªé è¨­å»ºç«‹ | `virsh pool-define-as default dir --target /var/lib/libvirt/images` | âœ… å·²è§£æ±º |
| 4 | libvirt default network ä¸å­˜åœ¨ / virbr0 stale | æ›¾è¢«åˆªé™¤æˆ–å¾æœªå»ºç«‹ | æ‰‹å‹•å»ºç«‹ network XML ä¸¦ `virsh net-start default` | âœ… å·²è§£æ±º |
| 5 | Guest VM ä¸ç™¼é€ DHCP è«‹æ±‚ | `generic/ubuntu2204` libvirt box çš„ cloud-init ç¶²è·¯è¨­å®šå•é¡Œ | ç„¡æ³•è§£æ±º â€” Guest ç¶²è·¯å®Œå…¨ä¸å•Ÿå‹• | âŒ **Blocker** |

#### è©³ç´°èªªæ˜

**å•é¡Œ 1-4ï¼šç’°å¢ƒé…ç½®**

KVM/libvirt çš„åˆå§‹ç’°å¢ƒè¨­å®šæ¯”è¼ƒç¹ç‘£ï¼Œéœ€è¦é€ä¸€ç¢ºèª storage poolã€networkã€bridge ç­‰åŸºç¤è¨­æ–½ã€‚å¦‚æœç³»çµ±ä¸ŠåŒæ™‚æœ‰ VMwareï¼Œé‚„è¦å…ˆåœæ‰ VMware çš„è™›æ“¬ç¶²è·¯ä»¥é¿å…è¡çªã€‚

**å•é¡Œ 5ï¼šGuest ç¶²è·¯ä¸å•Ÿå‹•ï¼ˆè‡´å‘½ï¼‰**

`generic/ubuntu2204` çš„ libvirt variant box å•Ÿå‹•å¾Œï¼ŒGuest OS å¾ä¸ç™¼å‡º DHCP requestã€‚libvirt çš„ dnsmasq æ—¥èªŒä¸­å®Œå…¨çœ‹ä¸åˆ°ä»»ä½• DHCP äº¤æ¡ã€‚æ¨æ¸¬æ˜¯ box å…§å»ºçš„ cloud-init/netplan è¨­å®šèˆ‡ libvirt é è¨­ç¶²è·¯ä¸åŒ¹é…ã€‚

```
virsh domifaddr <vm>  â†’ ç©ºç™½ï¼ˆç„¡ IPï¼‰
libvirt dnsmasq log   â†’ ç„¡ä»»ä½• DHCP è¨˜éŒ„
```

#### çµè«–

> âŒ **ä¸å¯ç”¨**ã€‚libvirt ç’°å¢ƒè¨­å®šè¤‡é›œï¼Œä¸” `generic/ubuntu2204` libvirt box çš„ Guest ç¶²è·¯æœ‰æ ¹æœ¬æ€§å•é¡Œã€‚

---

### 17.3 VirtualBox 7.2.6

**ç‰ˆæœ¬**ï¼šVirtualBox 7.2.6 r172322
**Vagrant Box**ï¼š`generic/ubuntu2204`, `bento/ubuntu-22.04`

#### é­é‡å•é¡Œèˆ‡è§£æ³•

| # | å•é¡Œ | æ ¹å›  | è§£æ³• | çµæœ |
|---|------|------|------|------|
| 1 | Host-only network IP ç¯„åœé™åˆ¶ | VirtualBox é è¨­åªå…è¨± 192.168.56.0/21 | å»ºç«‹ `/etc/vbox/networks.conf` åŠ å…¥ `* 192.168.100.0/24` | âœ… å·²è§£æ±º |
| 2 | VMware vmnet2 ç¢°æ’ | vmnet2 ä½”ç”¨ 192.168.100.0 ç¶²æ®µ | `sudo vmware-networks --stop` | âœ… å·²è§£æ±º |
| 3 | VT-x è¢« KVM ä½”ç”¨ | KVM kernel module å·²è¼‰å…¥ | `sudo rmmod kvm_intel kvm` + åœæ­¢ libvirtd | âœ… å·²è§£æ±º |
| 4 | SSH timeoutï¼ˆå…©ç¨® box çš†å¤±æ•—ï¼‰ | Guest OS å•Ÿå‹•ä½† sshd ä¸å›æ‡‰ banner | è¨­å®š `boot_timeout=600`ã€å˜—è©¦å…©ç¨® boxï¼Œå‡å¤±æ•— | âŒ **Blocker** |

#### è©³ç´°èªªæ˜

**å•é¡Œ 1ï¼šIP ç¯„åœç™½åå–®**

VirtualBox 7+ æ–°å¢å®‰å…¨æ©Ÿåˆ¶ï¼Œhost-only network åªèƒ½ä½¿ç”¨ç™½åå–®ä¸­çš„ IP ç¯„åœã€‚

```bash
# è§£æ³•
sudo mkdir -p /etc/vbox
echo "* 192.168.100.0/24" | sudo tee /etc/vbox/networks.conf
```

**å•é¡Œ 3ï¼šHypervisor äº’æ–¥**

VirtualBox ä½¿ç”¨ VT-xï¼Œè€Œ KVM ä¹Ÿä½”ç”¨ VT-xã€‚å…©è€…ä¸èƒ½å…±å­˜ã€‚

```
VBoxManage: error: VT-x is being used by another hypervisor (VERR_VMX_IN_VMX_ROOT_MODE)
```

```bash
# è§£æ³•ï¼šå¸è¼‰ KVM æ¨¡çµ„
sudo rmmod kvm_intel kvm
sudo systemctl stop libvirtd
```

**å•é¡Œ 4ï¼šSSH Timeoutï¼ˆè‡´å‘½ï¼‰**

å…©ç¨® box çš„ VM éƒ½èƒ½æ­£å¸¸å•Ÿå‹•ï¼ˆVBox.log é¡¯ç¤º kernel å·²å¼•å°ã€AHCI æ­£å¸¸ï¼‰ï¼ŒNAT port forward è¦å‰‡ä¹Ÿæ­£ç¢ºè¨­å®šã€‚`nc -zv 127.0.0.1 2222` é¡¯ç¤ºç«¯å£é–‹æ”¾ï¼Œä½† SSH é€£ç·šæ°¸é å¡åœ¨ banner exchangeï¼š

```
$ ssh -vvv -p 2222 vagrant@127.0.0.1
debug1: Connection established.
debug1: Local version string SSH-2.0-OpenSSH_9.6p1
  â† å°æ–¹æ°¸ä¸å›å‚³ SSH banner
  â† 10 åˆ†é˜å¾Œ timeout
```

VBox Guest Properties ä¸­å®Œå…¨æ²’æœ‰ç¶²è·¯è³‡è¨Šï¼ŒGuest Additions æœªå®‰è£/æœªå•Ÿå‹•ï¼ŒVBoxManage guestcontrol ä¹Ÿç„¡æ³•ä½¿ç”¨ã€‚æ¨æ¸¬ Guest å…§éƒ¨ sshd æœªå•Ÿå‹•æˆ–ç¶²è·¯æ£§æœªå®Œå…¨åˆå§‹åŒ–ã€‚

#### çµè«–

> âŒ **ä¸å¯ç”¨**ã€‚Guest VM å¯å¼•å°ä½† SSH æ°¸é ç„¡æ³•é€£æ¥ï¼Œç„¡è«–ä½¿ç”¨ `generic/ubuntu2204` æˆ– `bento/ubuntu-22.04`ã€‚

---

### 17.4 Docker (æœ€çµ‚æ–¹æ¡ˆ)

**ç‰ˆæœ¬**ï¼šDocker 28.2.2, Docker Compose V2
**æ˜ åƒ**ï¼šUbuntu 22.04 (Director), Nginx 1.24 (Real Server)

#### å¯¦æ¸¬éç¨‹

| æ­¥é©Ÿ | è€—æ™‚ | çµæœ |
|------|------|------|
| Build æ‰€æœ‰æ˜ åƒ (é¦–æ¬¡) | ~60 ç§’ | âœ… |
| å•Ÿå‹• 5 å€‹å®¹å™¨ | ~3 ç§’ | âœ… |
| Keepalived ç©©å®š | ~10 ç§’ | âœ… VIP æ­£ç¢ºåˆ†é…åˆ° MASTER |
| åŸºæœ¬é€£ç·šæ¸¬è©¦ | å³æ™‚ | âœ… VIP å¯é”, HTTP 200 |
| è² è¼‰åˆ†é… (50 req) | ~5 ç§’ | âœ… WRR 3:2 ç²¾ç¢ºåˆ†é… (60%:40%) |
| æ•ˆèƒ½æ¸¬è©¦ (500 req) | ~1 ç§’ | âœ… 18,538 req/sec, 0 å¤±æ•— |
| Failover æ¸¬è©¦ | ~5 ç§’ | âœ… VIP è½‰ç§»åˆ° BACKUP |
| Recovery æ¸¬è©¦ | ~5 ç§’ | âœ… VIP æ¶å› MASTER |
| DSR é©—è­‰ | å³æ™‚ | âœ… OutPkts=0 ç¢ºèª DSR |

**é›¶å•é¡Œï¼Œé›¶ workaroundï¼Œä¸€æ¬¡æˆåŠŸã€‚**

---

### 17.5 ç¸½è©•æ¯”

| è©•ä¼°é¢å‘ | VMware WS 25 | KVM/libvirt | VirtualBox 7.2 | Docker |
|----------|:---:|:---:|:---:|:---:|
| **å¯ç”¨æ€§** | âŒ ä¸å¯ç”¨ | âŒ ä¸å¯ç”¨ | âŒ ä¸å¯ç”¨ | âœ… å®Œç¾ |
| **å•Ÿå‹•é€Ÿåº¦** | ~5 åˆ†é˜ (ç†è«–) | ~3 åˆ†é˜ (ç†è«–) | ~3 åˆ†é˜ (ç†è«–) | **~3 ç§’** |
| **è³‡æºæ¶ˆè€—** | 2.8 GB RAM | 2.8 GB RAM | 2.8 GB RAM | **~200 MB** |
| **ç’°å¢ƒé…ç½®** | è¤‡é›œ (3 å€‹å•é¡Œ) | è¤‡é›œ (5 å€‹å•é¡Œ) | ä¸­ç­‰ (4 å€‹å•é¡Œ) | **é›¶é…ç½®** |
| **Hypervisor äº’æ–¥** | èˆ‡ KVM è¡çª | èˆ‡ VMware è¡çª | èˆ‡ KVM è¡çª | **ç„¡è¡çª** |
| **IPVS/DSR æ”¯æ´** | å®Œæ•´ (VM æ ¸å¿ƒ) | å®Œæ•´ (VM æ ¸å¿ƒ) | å®Œæ•´ (VM æ ¸å¿ƒ) | âœ… å…±äº« Host æ ¸å¿ƒ |
| **VRRP Multicast** | âœ… | âœ… | âœ… | âœ… (bridge net) |
| **ARP æŠ‘åˆ¶** | âœ… | âœ… | âœ… | âœ… (privileged) |
| **å¯é‡ç¾æ€§** | ä½ (ä¾è³´ç‰ˆæœ¬) | ä½ (ä¾è³´ç‰ˆæœ¬) | ä½ (ä¾è³´ç‰ˆæœ¬) | **é«˜ (Dockerfile)** |
| **CI/CD æ•´åˆ** | âŒ å›°é›£ | âš ï¸ éœ€ nested virt | âŒ å›°é›£ | **âœ… åŸç”Ÿæ”¯æ´** |

### 17.6 ç‚ºä»€éº¼ VM æ–¹æ¡ˆå…¨éƒ¨å¤±æ•—ï¼Ÿ

ä¸‰ç¨® Hypervisor åœ¨ç›¸åŒç¡¬é«”ä¸Šéƒ½é‡åˆ°äº† **Guest ç¶²è·¯/SSH ä¸å¯ç”¨**çš„è‡´å‘½å•é¡Œï¼Œæ ¹å› æ­¸ç´å¦‚ä¸‹ï¼š

```
                    å…±åŒå•é¡Œ                           æ ¹å› 
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
VMware    â”€â”€â–º â”‚ Guest Tools     â”‚ â† open-vm-tools ä¸ç›¸å®¹ WS 25
              â”‚ ä¸å›å ± IP       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
KVM       â”€â”€â–º â”‚ Guest ä¸ç™¼       â”‚ â† cloud-init/netplan è¨­å®š
              â”‚ DHCP request    â”‚   èˆ‡ libvirt é è¨­ç¶²è·¯ä¸åŒ¹é…
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
VirtualBoxâ”€â”€â–º â”‚ sshd ä¸å›æ‡‰      â”‚ â† Guest Additions ç¼ºå¤±
              â”‚ SSH banner      â”‚   Guest ç¶²è·¯æ£§åˆå§‹åŒ–ç•°å¸¸
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å…±é€šå› ç´ ï¼š
1. **Kernel 6.14.0-1020-oem** â€” è¼ƒæ–°çš„ OEM kernel èˆ‡å„ Hypervisor çš„ kernel module ç›¸å®¹æ€§å·®
2. **Vagrant Box çš„ Guest Agent** â€” `generic/ubuntu2204` å’Œ `bento/ubuntu-22.04` çš„ guest tools ç‰ˆæœ¬è½å¾Œ
3. **å¤š Hypervisor å…±å­˜** â€” VMware vmnetã€KVM virbrã€VirtualBox vboxnet äº’ç›¸å¹²æ“¾

### 17.7 é¸å‹å»ºè­°

| å ´æ™¯ | æ¨è–¦æ–¹æ¡ˆ | ç†ç”± |
|------|---------|------|
| **PoC / æ•™å­¸ / å¿«é€Ÿé©—è­‰** | **Docker** | ç§’ç´šå•Ÿå‹•ã€é›¶é…ç½®ã€100% å¯é‡ç¾ |
| **éœ€è¦å®Œæ•´ OS éš”é›¢** | KVM + æ‰‹å‹•å®‰è£ (é Vagrant) | è·³é Vagrant box çš„ guest agent å•é¡Œ |
| **ç”Ÿç”¢ç’°å¢ƒæ¨¡æ“¬** | Bare metal + Ansible | æœ€æ¥è¿‘çœŸå¯¦ç’°å¢ƒ |
| **CI/CD Pipeline** | **Docker** | GitHub Actions/GitLab CI åŸç”Ÿæ”¯æ´ |
| **è·¨ Hypervisor æ¸¬è©¦** | æ›´æ–°è‡³ä¸»æµ kernel + ç­‰å¾… box æ›´æ–° | ç›®å‰ OEM kernel ç›¸å®¹æ€§ä¸ä½³ |

> **çµè«–**ï¼šå°æ–¼ LVS/IPVS PoC è€Œè¨€ï¼ŒDocker æ˜¯æœ€ä½³é¸æ“‡ã€‚IPVS é‹ä½œåœ¨ Linux kernel å±¤ï¼Œprivileged container å¯ä»¥å®Œæ•´å­˜å– kernel çš„ netfilter/IPVS å­ç³»çµ±ï¼ŒDSR æ¨¡å¼ã€VRRP multicastã€ARP æŠ‘åˆ¶å…¨éƒ¨æ­£å¸¸é‹ä½œï¼ŒåŒæ™‚çœå»äº† VM çš„å•Ÿå‹•é–‹éŠ·å’Œ guest agent ç›¸å®¹æ€§å•é¡Œã€‚

---

## 18. Docker Compose åš LVSï¼šèƒ½åŠ›é‚Šç•Œèˆ‡ç”Ÿç”¢å·®ç•°åˆ†æ

### 18.1 Docker Compose èƒ½å®Œæ•´æ¼”ç·´ LVS å—ï¼Ÿ

**å¯ä»¥ï¼Œæœ¬ PoC å·²å¯¦è­‰ã€‚** ä»¥ä¸‹æ˜¯æ¯å€‹ LVS æ ¸å¿ƒåŠŸèƒ½åœ¨ Docker å®¹å™¨ä¸­çš„é©—è­‰çµæœï¼š

| é©—è­‰é …ç›® | VM ç’°å¢ƒ (ç†è«–) | Docker Compose (å¯¦æ¸¬) | ç‚ºä»€éº¼è¡Œå¾—é€š |
|----------|:-:|:-:|------|
| IPVS DR (DSR) æ¨¡å¼ | âœ… | âœ… `OutPkts=0` å·²è­‰æ˜ | IPVS åœ¨ kernel å±¤é‹ä½œï¼Œprivileged å®¹å™¨å®Œæ•´å­˜å– |
| WRR åŠ æ¬Šæ’ç¨‹ | âœ… | âœ… 60%:40% ç²¾ç¢ºå‘½ä¸­ | `ipvsadm` åœ¨å®¹å™¨ä¸­æ­£å¸¸æ“ä½œ kernel IPVS è¡¨ |
| Keepalived VRRP | âœ… | âœ… VIP æ¼‚ç§»æˆåŠŸ | multicast é€é Docker bridge network æ­£å¸¸å‚³é |
| ARP æŠ‘åˆ¶ | âœ… | âœ… `arp_ignore=1` | privileged å®¹å™¨å¯ç›´æ¥å¯« `/proc/sys/` |
| VIP on loopback | âœ… | âœ… `lo:0` ç¶å®šæˆåŠŸ | `ip addr add` åœ¨å®¹å™¨å…§æ­£å¸¸é‹ä½œ |
| Health Check | âœ… | âœ… HTTP GET /health | Keepalived æ­£å¸¸åµæ¸¬ RS å­˜æ´»ç‹€æ…‹ |
| Failover + Recovery | âœ… | âœ… ç§’ç´šåˆ‡æ› + æ¶å å›å¾© | VRRP ç‹€æ…‹æ©Ÿå®Œæ•´é‹ä½œ |

**é—œéµåŸå› ï¼šIPVS æ˜¯ Linux kernel å­ç³»çµ±ï¼Œä¸æ˜¯ userspace ç¨‹å¼ã€‚**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Linux Host                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚Director-1â”‚ â”‚Director-2â”‚ â”‚ RS-1/2   â”‚  â† å®¹å™¨      â”‚
â”‚  â”‚privilegedâ”‚ â”‚privilegedâ”‚ â”‚privilegedâ”‚    (userspace)â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€ namespace â”€â”€â”€â”‚
â”‚       â–¼             â–¼            â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚         Linux Kernel                 â”‚             â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚             â”‚
â”‚  â”‚   â”‚  IPVS   â”‚  â”‚ netfilterâ”‚         â”‚  â† å…±äº«     â”‚
â”‚  â”‚   â”‚ (ip_vs) â”‚  â”‚  (ARP)   â”‚         â”‚    kernel   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

`privileged: true` çš„å®¹å™¨ç›´æ¥æ“ä½œ host kernel çš„ IPVS å­ç³»çµ±ï¼Œå’Œåœ¨ VM è£¡åŸ·è¡Œ**æ²’æœ‰ä»»ä½•åŠŸèƒ½å·®ç•°**ã€‚

### 18.2 ç‚ºä»€éº¼ Production ä¸é©åˆç”¨ Docker Composeï¼Ÿ

Docker Compose è®“æ‰€æœ‰å®¹å™¨è·‘åœ¨åŒä¸€å° Host ä¸Šï¼Œé€™åœ¨ PoC ä¸­æ²’å•é¡Œï¼Œä½†åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­é•åäº† HA çš„åŸºæœ¬å‰æï¼š

```
  PoC (æ‰€æœ‰å®¹å™¨åœ¨åŒä¸€å° Host)               Production (è·¨å¯¦é«”æ©Ÿéƒ¨ç½²)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Single Host       â”‚           â”‚ å¯¦é«”æ©Ÿ A  â”‚   â”‚ å¯¦é«”æ©Ÿ B  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”         â”‚           â”‚ Director â”‚   â”‚ Director â”‚
â”‚ â”‚Dir-1â”‚ â”‚Dir-2â”‚ â† åŒæ©Ÿ   â”‚           â”‚ (MASTER) â”‚   â”‚ (BACKUP) â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜   æ¶å    â”‚           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
â”‚ â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”   æ„ç¾©ä¸å¤§  â”‚                â”‚   L2 Switch   â”‚
â”‚ â”‚RS-1â”‚ â”‚RS-2â”‚            â”‚           â”Œâ”€â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”
â”‚ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜            â”‚           â”‚       â”‚       â”‚        â”‚
â”‚                          â”‚          â”Œâ”´â”€â”€â”  â”Œâ”´â”€â”€â”  â”Œâ”´â”€â”€â”  â”Œâ”€â”´â”€â”
â”‚  Host æ› = å…¨éƒ¨æ› ğŸ’€     â”‚          â”‚RS1â”‚  â”‚RS2â”‚  â”‚RS3â”‚  â”‚RSNâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”˜  â””â”€â”€â”€â”˜  â””â”€â”€â”€â”˜  â””â”€â”€â”€â”˜
                                       å„è‡ªç¨ç«‹ï¼Œä»»ä¸€å°æ›ä¸å½±éŸ¿æœå‹™
```

| é¢å‘ | Docker Compose (PoC) | ç”Ÿç”¢ç’°å¢ƒ (å¤šæ©Ÿ) |
|------|:-:|:-:|
| **å–®é»æ•…éšœ** | âŒ Host æ›äº† = å…¨éƒ¨æ› | âœ… æ¯å€‹è§’è‰²åœ¨ä¸åŒå¯¦é«”æ©Ÿ |
| **ç¶²è·¯éš”é›¢** | âš ï¸ bridge network (L2 æ¨¡æ“¬) | âœ… çœŸæ­£çš„ç‰©ç†äº¤æ›æ©Ÿ / VLAN |
| **VRRP æ¶å ** | âš ï¸ åŒ Host å®¹å™¨äº’æ¶æ„ç¾©ä¸å¤§ | âœ… è·¨æ©Ÿå™¨ VIP æ¼‚ç§»æ‰æœ‰å®¹ç½æ„ç¾© |
| **æ•ˆèƒ½ç“¶é ¸** | âš ï¸ bridge æœ‰é¡å¤– overhead | âœ… ç›´æ¥èµ° NICï¼Œé›¶ overhead |
| **æ ¸å¿ƒå‡ç´š** | âŒ Host kernel å‡ç´šå½±éŸ¿å…¨éƒ¨å®¹å™¨ | âœ… å¯é€å°æ»¾å‹•å‡ç´š |
| **æ•…éšœéš”é›¢** | âŒ ä¸€å€‹ privileged å®¹å™¨å¯å½±éŸ¿å…¨éƒ¨ | âœ… äº’ä¸å½±éŸ¿ |

### 18.3 ç”Ÿç”¢ç’°å¢ƒçš„æ­£ç¢ºåšæ³•

**å¤šå°å¯¦é«”æ©Ÿ / VM + è‡ªå‹•åŒ–éƒ¨ç½²å·¥å…·ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¯¦é«”æ©Ÿ A         â”‚     â”‚   å¯¦é«”æ©Ÿ B         â”‚
â”‚   Director-1      â”‚     â”‚   Director-2      â”‚
â”‚   Keepalived      â”‚     â”‚   Keepalived      â”‚
â”‚   MASTER (pri=100)â”‚     â”‚   BACKUP (pri=90) â”‚
â”‚   VIP: .100  â­   â”‚     â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚         L2 Switch       â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”
    â”‚         â”‚            â”‚          â”‚
â”Œâ”€â”€â”€â”´â”€â”€â”  â”Œâ”€â”€â”´â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”  â”Œâ”€â”€â”€â”´â”€â”€â”
â”‚å¯¦é«”æ©ŸCâ”‚  â”‚å¯¦é«”æ©ŸDâ”‚  â”‚å¯¦é«”æ©ŸEâ”‚  â”‚å¯¦é«”æ©ŸFâ”‚
â”‚ RS-1  â”‚  â”‚ RS-2  â”‚  â”‚ RS-3  â”‚  â”‚ RS-N  â”‚
â”‚ w=3   â”‚  â”‚ w=2   â”‚  â”‚ w=1   â”‚  â”‚ w=1   â”‚
â”‚ Nginx â”‚  â”‚ Nginx â”‚  â”‚ Nginx â”‚  â”‚ Nginx â”‚
â”‚VIP@lo â”‚  â”‚VIP@lo â”‚  â”‚VIP@lo â”‚  â”‚VIP@lo â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

å¸¸è¦‹éƒ¨ç½²å·¥å…·éˆï¼š

| å·¥å…· | ç”¨é€” | é©åˆå ´æ™¯ |
|------|------|---------|
| **Ansible** | æ‰¹é‡é…ç½® keepalived.conf, sysctl, nginx | Bare metal / VM |
| **Terraform + Ansible** | é–‹ VM + é…ç½® LVS | ç§æœ‰é›² (OpenStack, vSphere) |
| **PXE + Kickstart** | è£¸æ©Ÿè‡ªå‹•åŒ–éƒ¨ç½² | å¤§è¦æ¨¡ Data Center |
| **SaltStack** | å³æ™‚é…ç½®ç®¡ç† | éœ€è¦å³æ™‚è®Šæ›´çš„ç’°å¢ƒ |

### 18.4 ç¾ä»£æ¶æ§‹ä¸­çš„ L4 è² è¼‰å‡è¡¡æ–¹æ¡ˆ

åœ¨ç¾ä»£æ¶æ§‹ä¸­ï¼Œç›´æ¥æ‰‹å‹•éƒ¨ç½² LVS/IPVS çš„å ´æ™¯å·²ç¶“ä¸å¤šã€‚ä»¥ä¸‹æ˜¯æ›´å¸¸è¦‹çš„æ›¿ä»£æ–¹æ¡ˆï¼Œ**ä½†å®ƒå€‘çš„åº•å±¤åŸç†å’Œæœ¬ PoC æ•™çš„å…§å®¹ä¸€è‡´**ï¼š

| æ–¹æ¡ˆ | å±¤ç´š | åº•å±¤æŠ€è¡“ | é©åˆå ´æ™¯ |
|------|------|---------|---------|
| **kube-proxy (ipvs mode)** | L4 | å°±æ˜¯æœ¬ PoC æ•™çš„ IPVS | K8s å¢é›†å…§éƒ¨ |
| **MetalLB** | L4 | IPVS + ARP/BGP | K8s bare-metal LoadBalancer |
| **Cilium (eBPF LB)** | L4 | eBPF å–ä»£ IPVSï¼Œæ›´é«˜æ•ˆ | é«˜æ•ˆèƒ½ K8s å¢é›† |
| **HAProxy (L4 mode)** | L4 | Userspace proxy | ä¸æƒ³ç¢° kernel module |
| **Nginx Stream** | L4 | Userspace proxy | ç°¡å–® TCP/UDP è² è¼‰å‡è¡¡ |
| **AWS NLB / GCP L4 LB** | L4 | é›²ç«¯è‡ªæœ‰å¯¦ä½œ | é›²ç«¯ç’°å¢ƒ |
| **Keepalived + LVS** | L4 | æœ¬ PoC æ–¹æ¡ˆ | Bare metal é«˜æ•ˆèƒ½éœ€æ±‚ |

```
ä½ å­¸çš„ LVS/IPVS çŸ¥è­˜åœ¨é€™äº›å ´æ™¯éƒ½ç”¨å¾—åˆ°ï¼š

  æœ¬ PoC                    Kubernetes
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ipvsadm  â”‚            â”‚ kube-proxy       â”‚
â”‚ wrr æ’ç¨‹  â”‚ â”€â”€ ç›¸åŒ â”€â”€â–ºâ”‚ --proxy-mode=ipvsâ”‚
â”‚ DR æ¨¡å¼   â”‚   åŸç†     â”‚ IPVS + DNAT      â”‚
â”‚ keepalivedâ”‚            â”‚ MetalLB (ARP)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 18.5 çµè«–

| å•é¡Œ | ç­”æ¡ˆ |
|------|------|
| Docker Compose èƒ½åš LVS PoC æ¼”ç·´ï¼Ÿ | âœ… **å®Œå…¨å¯ä»¥** â€” kernel å±¤åŠŸèƒ½å…¨éƒ¨æ­£å¸¸é‹ä½œ |
| Docker Compose èƒ½ç•¶ Production LVSï¼Ÿ | âŒ **ä¸é©åˆ** â€” å–® Host ç„¡æ³•å¯¦ç¾çœŸæ­£çš„ HA |
| Docker Compose çš„å®šä½ï¼Ÿ | **æœ€ä½³å­¸ç¿’å¯¦é©—å®¤** â€” ç”¨æœ€ä½æˆæœ¬ç†è§£ IPVS/DSR/VRRP åŸç† |
| Production LVS è©²æ€éº¼åšï¼Ÿ | å¤šå°å¯¦é«”æ©Ÿ + Ansible éƒ¨ç½²ï¼Œæˆ–ç›´æ¥ç”¨ K8s + MetalLB |
| å­¸ LVS æœ‰ä»€éº¼ç”¨ï¼Ÿ | kube-proxyã€MetalLBã€Cilium åº•å±¤éƒ½æ˜¯åŒæ¨£çš„ IPVS åŸç† |

> **ä¸€å¥è©±ç¸½çµï¼šDocker Compose æ˜¯æœ€å¥½çš„ã€ŒLVS æ•™å­¸å¯¦é©—å®¤ã€ï¼Œä½†ä¸æ˜¯ç”Ÿç”¢ç´š LVS çš„éƒ¨ç½²æ–¹å¼ã€‚ç†è§£åŸç†å¾Œï¼Œåœ¨ Kubernetes çš„ kube-proxy (ipvs mode) å’Œ MetalLB ä¸­æœƒå†æ¬¡çœ‹åˆ°å®Œå…¨ç›¸åŒçš„æŠ€è¡“ã€‚**

---

## 19. åˆå­¸è€…å®Œæ•´æ“ä½œæ•™å­¸ (Step-by-Step)

> æœ¬ç¯€å¸¶ä½ **å¾é›¶é–‹å§‹**ï¼Œä¸€æ­¥æ­¥æ“ä½œå®Œæ•´å€‹ LVS DSR è² è¼‰å‡è¡¡ PoCã€‚æ¯ä¸€æ­¥éƒ½é™„ä¸Š**å¯¦éš›æŒ‡ä»¤**å’Œ**çœŸå¯¦çµ‚ç«¯è¼¸å‡º**ï¼Œè®“ä½ è·Ÿè‘—åšå°±èƒ½æˆåŠŸã€‚

### Step 0ï¼šä½ éœ€è¦ä»€éº¼ï¼Ÿ

| éœ€æ±‚ | æœ€ä½ç‰ˆæœ¬ | ç¢ºèªæ–¹å¼ |
|------|---------|---------|
| Linux (Ubuntu/Debian) | 22.04+ | `uname -r` |
| Docker | 20.10+ | `docker --version` |
| Docker Compose | V2 | `docker compose version` |
| IPVS æ ¸å¿ƒæ¨¡çµ„ | Linux å…§å»º | `lsmod \| grep ip_vs` |

å¦‚æœ IPVS æ¨¡çµ„æœªè¼‰å…¥ï¼š
```bash
sudo modprobe ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh
```

---

### Step 1ï¼šç¢ºèªç’°å¢ƒ

```bash
$ docker --version
Docker version 28.2.2, build 28.2.2-0ubuntu1~24.04.1

$ docker compose version
Docker Compose version v5.0.2

$ lsmod | grep ip_vs
ip_vs_sh               12288  0
ip_vs_wrr              12288  0
ip_vs_rr               12288  0
ip_vs                 225280  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr
```

> **çœ‹åˆ° `ip_vs` å°±å°äº†ï¼** é€™ä»£è¡¨ Linux kernel çš„ IPVS å­ç³»çµ±å·²ç¶“è¼‰å…¥ï¼ŒDocker å®¹å™¨å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

---

### Step 2ï¼šäº†è§£å°ˆæ¡ˆçµæ§‹

```bash
$ find docker/ -type f | sort
docker/client/Dockerfile                         # Client å®¹å™¨å®šç¾©
docker/client/test-scripts/test-all.sh           # å®Œæ•´æ¸¬è©¦å¥—ä»¶
docker/client/test-scripts/test-basic.sh         # åŸºæœ¬é€£ç·šæ¸¬è©¦
docker/client/test-scripts/test-distribution.sh  # è² è¼‰åˆ†é…æ¸¬è©¦
docker/client/test-scripts/test-dsr-verify.sh    # DSR å°åŒ…é©—è­‰
docker/client/test-scripts/test-failover.sh      # Failover ç›£æ§
docker/client/test-scripts/test-performance.sh   # æ•ˆèƒ½å£“åŠ›æ¸¬è©¦
docker/director/Dockerfile                       # Director å®¹å™¨å®šç¾©
docker/director/entrypoint.sh                    # Director å•Ÿå‹•è…³æœ¬
docker/realserver/Dockerfile                     # Real Server å®¹å™¨å®šç¾©
docker/realserver/entrypoint.sh                  # Real Server å•Ÿå‹•è…³æœ¬
```

```
å°ˆæ¡ˆæ¶æ§‹ï¼š

docker-compose.yml          â† å®šç¾© 5 å€‹å®¹å™¨å’Œç¶²è·¯
manage.sh                   â† å¢é›†ç®¡ç†è…³æœ¬ (up/down/test/failover...)
docker/
â”œâ”€â”€ director/
â”‚   â”œâ”€â”€ Dockerfile          â† Ubuntu 22.04 + ipvsadm + keepalived
â”‚   â””â”€â”€ entrypoint.sh       â† å‹•æ…‹ç”Ÿæˆ keepalived.confï¼Œå•Ÿå‹• Keepalived
â”œâ”€â”€ realserver/
â”‚   â”œâ”€â”€ Dockerfile          â† Nginx 1.24 + iproute2
â”‚   â””â”€â”€ entrypoint.sh       â† ARP æŠ‘åˆ¶ + VIP on loopback + å•Ÿå‹• Nginx
â””â”€â”€ client/
    â”œâ”€â”€ Dockerfile          â† Ubuntu 22.04 + curl + ab + tcpdump
    â””â”€â”€ test-scripts/       â† 5 å€‹è‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬
```

---

### Step 3ï¼šå•Ÿå‹•å¢é›†

é€™æ˜¯æœ€é—œéµçš„ä¸€æ­¥ã€‚ä¸€å€‹æŒ‡ä»¤å•Ÿå‹•æ•´å€‹ 5 ç¯€é»å¢é›†ï¼š

```bash
$ ./manage.sh up
```

**ä½ æœƒçœ‹åˆ°ï¼š**

```
ğŸš€ Starting LVS PoC Cluster (Docker)...

Building and starting: Directors â†’ Real Servers â†’ Client
```

Docker æœƒè‡ªå‹• build ä¸‰ç¨®æ˜ åƒæª”ï¼ˆé¦–æ¬¡ç´„ 1-2 åˆ†é˜ï¼‰ï¼Œç„¶å¾ŒæŒ‰é †åºå•Ÿå‹•å®¹å™¨ã€‚

ç­‰å¾… 10 ç§’è®“ Keepalived ç©©å®šå¾Œï¼Œè‡ªå‹•é¡¯ç¤ºå¢é›†ç‹€æ…‹ï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   LVS PoC Cluster Status                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”€â”€ Container Status â”€â”€
NAME             IMAGE                                  COMMAND            SERVICE
lvs-client       service-load-balancer-client           "sleep infinity"   client
lvs-director-1   service-load-balancer-lvs-director-1   "/entrypoint.sh"   lvs-director-1
lvs-director-2   service-load-balancer-lvs-director-2   "/entrypoint.sh"   lvs-director-2
real-server-1    service-load-balancer-real-server-1    "/entrypoint.sh"   real-server-1
real-server-2    service-load-balancer-real-server-2    "/entrypoint.sh"   real-server-2
```

> **æª¢æŸ¥é‡é» 1ï¼šIPVS è·¯ç”±è¡¨**

```
â”€â”€ Director-1 IPVS Table â”€â”€
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  192.168.100.100:80 wrr
  -> 192.168.100.21:80            Route   3      0          0
  -> 192.168.100.22:80            Route   2      0          0
```

é€™å¼µè¡¨å‘Šè¨´ä½ ï¼š
- **VIP**: `192.168.100.100:80` â€” å®¢æˆ¶ç«¯å­˜å–é€™å€‹ IP
- **Scheduler**: `wrr` â€” åŠ æ¬Šè¼ªè©¢æ’ç¨‹
- **Forward**: `Route` â€” å°±æ˜¯ DR (DSR) æ¨¡å¼
- **Weight**: `3` å’Œ `2` â€” RS-1 æ¥æ”¶ 60% æµé‡ï¼ŒRS-2 æ¥æ”¶ 40%

> **æª¢æŸ¥é‡é» 2ï¼šVIP ä½ç½®å’Œ RS å¥åº·ç‹€æ…‹**

```
â”€â”€ VIP Location â”€â”€
  âœ… VIP is on: lvs-director-1

â”€â”€ Real Server Health â”€â”€
  âœ… real-server-1 (192.168.100.21): Healthy
  âœ… real-server-2 (192.168.100.22): Healthy
```

å…¨éƒ¨ âœ… ä»£è¡¨å¢é›†å·²ç¶“å°±ç·’ï¼

---

### Step 4ï¼šåŸ·è¡Œå®Œæ•´æ¸¬è©¦

```bash
$ ./manage.sh test
```

**æ¸¬è©¦åˆ†ä¸‰å€‹éšæ®µè‡ªå‹•åŸ·è¡Œï¼š**

#### Phase 1ï¼šåŸºæœ¬é€£ç·š

```
â–¶ Phase 1: Basic Connectivity
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”€â”€ Test 1: VIP Reachability â”€â”€
PING 192.168.100.100 (192.168.100.100) 56(84) bytes of data.
64 bytes from 192.168.100.100: icmp_seq=1 ttl=64 time=0.116 ms
64 bytes from 192.168.100.100: icmp_seq=2 ttl=64 time=0.069 ms
64 bytes from 192.168.100.100: icmp_seq=3 ttl=64 time=0.064 ms
3 packets transmitted, 3 received, 0% packet loss
  âœ… VIP is reachable

â”€â”€ Test 2: HTTP Response â”€â”€
  âœ… HTTP 200 OK

â”€â”€ Test 3: Server Identity (10 requests) â”€â”€
  Request 1: Served by real-server-1     â† weight=3ï¼Œå‡ºç¾è¼ƒå¤š
  Request 2: Served by real-server-1
  Request 3: Served by real-server-2     â† weight=2ï¼Œå‡ºç¾è¼ƒå°‘
  Request 4: Served by real-server-1
  Request 5: Served by real-server-2
  Request 6: Served by real-server-1
  Request 7: Served by real-server-1
  Request 8: Served by real-server-2
  Request 9: Served by real-server-1
  Request 10: Served by real-server-2
```

> **çœ‹æ‡‚çµæœ**ï¼š10 æ¬¡è«‹æ±‚ä¸­ï¼ŒRS-1 å‡ºç¾ 6 æ¬¡ (60%)ï¼ŒRS-2 å‡ºç¾ 4 æ¬¡ (40%)ï¼Œç¬¦åˆ WRR 3:2 æ¬Šé‡ï¼

#### Phase 2ï¼šè² è¼‰åˆ†é…ç²¾ç¢ºåº¦

```
â–¶ Phase 2: Load Distribution (50 requests)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”€â”€ Distribution Results â”€â”€
  real-server-1    :   30 requests ( 60.0%) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  real-server-2    :   20 requests ( 40.0%) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

  Total successful: 50 / 50
```

> **çœ‹æ‡‚çµæœ**ï¼š50 æ¬¡è«‹æ±‚ï¼ŒRS-1 æ‹¿åˆ° 30 å€‹ (60%)ï¼ŒRS-2 æ‹¿åˆ° 20 å€‹ (40%)ã€‚**ç²¾ç¢ºå‘½ä¸­** WRR 3:2 = 60%:40% çš„æ•¸å­¸é æœŸï¼

#### Phase 3ï¼šæ•ˆèƒ½å£“åŠ›æ¸¬è©¦

```
â–¶ Phase 3: Performance (500 req, 10 concurrent)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Complete requests:      500
Failed requests:        0                   â† é›¶å¤±æ•—ï¼
Requests per second:    12965.12 [#/sec]    â† æ¯ç§’ ~13,000 è«‹æ±‚
Time per request:       0.077 [ms]          â† æ¯æ¬¡è«‹æ±‚ä¸åˆ° 0.1 æ¯«ç§’
```

> **çœ‹æ‡‚çµæœ**ï¼š500 å€‹è«‹æ±‚å…¨éƒ¨æˆåŠŸï¼Œé›¶å¤±æ•—ã€‚Layer-4 è² è¼‰å‡è¡¡çš„æ•ˆèƒ½é è¶… Layer-7 (Nginx proxy) å› ç‚ºåªåšå°åŒ…è½‰ç™¼ï¼Œä¸è§£æ HTTP å…§å®¹ã€‚

---

### Step 5ï¼šæ¨¡æ“¬ Director æ•…éšœ (Failover)

é€™æ˜¯ HA é«˜å¯ç”¨çš„æ ¸å¿ƒæ¸¬è©¦ â€” ä¸» Director æ›äº†ï¼Œå‚™æ´ Director èƒ½ä¸èƒ½ç§’ç´šæ¥æ‰‹ï¼Ÿ

```bash
$ ./manage.sh failover
```

```
ğŸ”„ Simulating Director Failover...

â”€â”€ Before failover â”€â”€
  VIP is currently on: lvs-director-1     â† VIP ç›®å‰åœ¨ MASTER

â”€â”€ Stopping Keepalived on Director-1 (MASTER) â”€â”€
  Waiting 5s for failover...

â”€â”€ After failover â”€â”€
  âœ… VIP moved to: lvs-director-2         â† VIP è‡ªå‹•è½‰ç§»åˆ° BACKUPï¼

â”€â”€ Testing VIP from client â”€â”€
{
  "server": "real-server-2",
  "ip": "192.168.100.22",
  "vip": "192.168.100.100",
  "timestamp": "2026-02-27T16:44:02Z"
}                                          â† Client é€é VIP ä»èƒ½å­˜å–å¾Œç«¯

âœ… Failover test complete.
```

> **ç™¼ç”Ÿäº†ä»€éº¼ï¼Ÿ**
> 1. Director-1 (MASTER, priority=100) è¢«åœæ‰
> 2. Director-2 (BACKUP, priority=90) åµæ¸¬åˆ° VRRP å¿ƒè·³æ¶ˆå¤±
> 3. Director-2 è‡ªå‹•å‡ç´šç‚º MASTERï¼Œæ¥ç®¡ VIP (192.168.100.100)
> 4. Client å®Œå…¨ç„¡æ„Ÿ â€” åŒæ¨£çš„ VIP ä»ç„¶èƒ½æ­£å¸¸æœå‹™

---

### Step 6ï¼šæ¢å¾© Director (Recovery + Preemption)

```bash
$ ./manage.sh recover
```

```
ğŸ”§ Recovering Director-1...
  Waiting 5s for preemption...

â”€â”€ After recovery â”€â”€
  âœ… VIP is on: lvs-director-1            â† VIP æ¶å›åˆ°é«˜å„ªå…ˆæ¬Šçš„ MASTER

âœ… Recovery complete.
```

> **æ¶å  (Preemption)**ï¼šDirector-1 æ¢å¾©å¾Œï¼Œå› ç‚ºå®ƒçš„ priority (100) é«˜æ–¼ Director-2 (90)ï¼ŒVRRP å”å®šæœƒè‡ªå‹•æŠŠ VIP æ¶å›ä¾†ã€‚é€™å°±æ˜¯ `preempt` æ©Ÿåˆ¶ã€‚

---

### Step 7ï¼šé©—è­‰ DSR (Direct Server Return)

DSR çš„æ ¸å¿ƒç‰¹å¾µæ˜¯ **Director åªçœ‹åˆ° Requestï¼Œä¸çœ‹åˆ° Response**ã€‚ç”¨ IPVS çµ±è¨ˆæ•¸æ“šä¾†é©—è­‰ï¼š

å…ˆç”¢ç”Ÿæµé‡ï¼Œå†æŸ¥çœ‹çµ±è¨ˆï¼š

```bash
# ç”¢ç”Ÿ 50 å€‹è«‹æ±‚
$ docker exec lvs-client bash -c \
    "for i in \$(seq 1 50); do curl -s -o /dev/null http://192.168.100.100/; done"

# æŸ¥çœ‹ IPVS çµ±è¨ˆ
$ docker exec lvs-director-1 ipvsadm -Ln --stats
```

```
                              Conns   InPkts  OutPkts  InBytes OutBytes
TCP  192.168.100.100:80          20      140        0     9020        0
  -> 192.168.100.21:80           12       84        0     5412        0
  -> 192.168.100.22:80            8       56        0     3608        0
```

> **çœ‹æ‡‚çµæœ â€” DSR çš„éµè­‰**ï¼š
>
> | æ¬„ä½ | å€¼ | æ„ç¾© |
> |------|-----|------|
> | `InPkts` | 140 | Director æ”¶åˆ° 140 å€‹é€²å…¥å°åŒ… (Client çš„ Request) |
> | **`OutPkts`** | **0** | **Director è½‰ç™¼äº† 0 å€‹å‡ºå»çš„å°åŒ…ï¼** |
> | `InBytes` | 9020 | é€²å…¥çš„ Request è³‡æ–™é‡ |
> | **`OutBytes`** | **0** | **Director æ²’æœ‰è½‰ç™¼ä»»ä½• Response è³‡æ–™ï¼** |
>
> **`OutPkts=0` å°±æ˜¯ DSR çš„ç›´æ¥è­‰æ“š**ï¼š
> - Request è·¯å¾‘ï¼šClient â†’ Director (æ”¹ MAC) â†’ Real Server
> - Response è·¯å¾‘ï¼šReal Server â†’ Client **ç›´æ¥å›æ‡‰ï¼Œä¸ç¶“é Director**
> - Director å®Œå…¨æ²’ç¢°åˆ° Response å°åŒ…ï¼Œæ‰€ä»¥ `OutPkts=0`

---

### Step 8ï¼šæŸ¥çœ‹ Keepalived æ—¥èªŒ

```bash
$ docker logs lvs-director-1 2>&1 | tail -15
```

```
Fri Feb 27 16:44:39 2026: (LVS_VIP) Entering MASTER STATE
Fri Feb 27 16:44:39 2026: (LVS_VIP) setting VIPs.
Fri Feb 27 16:44:39 2026: (LVS_VIP) Sending/queueing gratuitous ARPs on eth0 for 192.168.100.100
Fri Feb 27 16:44:39 2026: Sending gratuitous ARP on eth0 for 192.168.100.100
Fri Feb 27 16:44:39 2026: Sending gratuitous ARP on eth0 for 192.168.100.100
Fri Feb 27 16:44:42 2026: Remote Web server [192.168.100.21]:tcp:80 succeed on service.
Fri Feb 27 16:44:42 2026: Remote Web server [192.168.100.22]:tcp:80 succeed on service.
```

> **çœ‹æ‡‚æ—¥èªŒ**ï¼š
> - `Entering MASTER STATE` â€” Keepalived æ±ºå®šè‡ªå·±æ˜¯ MASTER
> - `Sending gratuitous ARP` â€” å»£æ’­ã€ŒVIP 192.168.100.100 åœ¨æˆ‘é€™è£¡ã€è®“æ‰€æœ‰äººæ›´æ–° ARP å¿«å–
> - `Remote Web server ... succeed on service` â€” Health Check ç¢ºèªå…©å° RS éƒ½å¥åº·

---

### Step 9ï¼šé€²å…¥å®¹å™¨æ¢ç´¢

ä½ å¯ä»¥é€²å…¥ä»»ä½•å®¹å™¨ï¼Œæ‰‹å‹•è§€å¯Ÿå…§éƒ¨ç‹€æ…‹ï¼š

```bash
# é€²å…¥ Director å®¹å™¨
$ docker exec -it lvs-director-1 bash

# åœ¨ Director å…§éƒ¨ï¼š
root@lvs-director-1:/# ipvsadm -Ln              # çœ‹ IPVS è·¯ç”±è¡¨
root@lvs-director-1:/# ip addr show | grep .100  # çœ‹ VIP ç¶åœ¨å“ª
root@lvs-director-1:/# lvs-status.sh             # å®Œæ•´ç‹€æ…‹å ±å‘Š
root@lvs-director-1:/# exit

# é€²å…¥ Real Server å®¹å™¨
$ docker exec -it real-server-1 bash

# åœ¨ Real Server å…§éƒ¨ï¼š
root@real-server-1:/# ip addr show lo            # çœ‹ VIP åœ¨ loopback ä¸Š
root@real-server-1:/# cat /proc/sys/net/ipv4/conf/all/arp_ignore   # æ‡‰ç‚º 1
root@real-server-1:/# cat /proc/sys/net/ipv4/conf/all/arp_announce  # æ‡‰ç‚º 2
root@real-server-1:/# curl http://localhost/health                   # æ‡‰å› OK
root@real-server-1:/# rs-status.sh               # å®Œæ•´ç‹€æ…‹å ±å‘Š
root@real-server-1:/# exit
```

---

### Step 10ï¼šåœæ­¢å¢é›†

```bash
$ ./manage.sh down
ğŸ›‘ Stopping LVS PoC Cluster...
âœ… All containers stopped.
```

å¦‚æœè¦å®Œå…¨æ¸…é™¤ï¼ˆåŒ…æ‹¬æ˜ åƒæª”ï¼‰ï¼š

```bash
$ ./manage.sh destroy
```

---

### å­¸åˆ°äº†ä»€éº¼ï¼Ÿ

å®Œæˆä»¥ä¸Š 10 å€‹æ­¥é©Ÿï¼Œä½ å·²ç¶“å¯¦éš›æ“ä½œéï¼š

| æ¦‚å¿µ | å°æ‡‰æ­¥é©Ÿ | ä½ åšäº†ä»€éº¼ |
|------|---------|-----------|
| **IPVS (Linux Virtual Server)** | Step 3 | çœ‹åˆ° `ipvsadm -Ln` çš„è·¯ç”±è¡¨ |
| **DSR (Direct Server Return)** | Step 7 | ç”¨ `OutPkts=0` è­‰æ˜ Response ä¸ç¶“é Director |
| **WRR (Weighted Round Robin)** | Step 4 Phase 2 | é©—è­‰ 60%:40% ç²¾ç¢ºåˆ†é… |
| **VRRP Failover** | Step 5 | åœæ‰ MASTERï¼ŒVIP è‡ªå‹•æ¼‚ç§»åˆ° BACKUP |
| **Preemption (æ¶å )** | Step 6 | MASTER æ¢å¾©å¾Œè‡ªå‹•æ¶å› VIP |
| **Health Check** | Step 8 | Keepalived æ—¥èªŒé¡¯ç¤º RS å¥åº·æª¢æŸ¥çµæœ |
| **ARP æŠ‘åˆ¶** | Step 9 | ç¢ºèª `arp_ignore=1`, `arp_announce=2` |
| **VIP on Loopback** | Step 9 | ç¢ºèª RS çš„ lo ä¸Šæœ‰ VIP |
| **Gratuitous ARP** | Step 8 | æ—¥èªŒé¡¯ç¤º VIP æ¥ç®¡æ™‚ç™¼é€ GARP |

> **é€™äº›çŸ¥è­˜ç›´æ¥é©ç”¨æ–¼**ï¼šKubernetes kube-proxy (ipvs mode)ã€MetalLBã€Ciliumã€ä»¥åŠä»»ä½•ä½¿ç”¨ IPVS çš„ç”Ÿç”¢ç’°å¢ƒã€‚

---

## æˆæ¬Š

æœ¬ PoC å°ˆæ¡ˆä¾›æ•™å­¸ä½¿ç”¨ï¼Œå¯è‡ªç”±ä¿®æ”¹å’Œåˆ†äº«ã€‚
